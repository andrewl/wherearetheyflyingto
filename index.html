<!DOCTYPE html>
<html>

<head>
  <title>Where are they flying to?</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
  <link rel="stylesheet" href="./css/nouislider.min.css" />
  <link rel="stylesheet" href="./css/nouislider.pips.css" />
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
  <script src="./js/nouislider.min.js"></script>
  <style>
  /* Simple CSS Reset */
    html, body, div, p{
      margin: 0;
      padding: 0;
      border: 0;
    }

    html {
      font-family: 'Montserrat', sans-serif;
      color: white;
      background-color: #0099CC;
      text-align: center;
    }
    
    a {
      color: white;
    }
    
    #altitude_selector {
      height: 200px;
      margin: 0 auto 30px;
    }

    #map {
      margin: 30px;
    }
    
    #map-canvas {
      height: 600px;
      margin: 0 auto 30px;
      border: 2px solid #003399;
    }

    .noUI-pips {
      color: black;
    }

    .noUi-value {
      color: black;
    }

    .noUi-connect {
      background-color: rgb(0,153,204);
    }
  </style>
</head>

<body>
  <div id="text">
  <h1>Where are they flying to?</h1>

  <p>Where Are They Flying To is a <a href="https://en.wikipedia.org/wiki/Heat_map" target="_other">heatmap</a> showing the destinations of flights that fly over my house. The data is collected by receiving and processing <a target="_other" href="https://en.wikipedia.org/wiki/Automatic_dependent_surveillance_%E2%80%93_broadcast">ADSB</a> broadcasts from aircraft and uploading them to this site each hour. You can zoom around the map and filter out flights above or below certain altitudes using the controls on the map.</p>

<p>To find out how the data is collected and this map produced, please visit <a href="https://github.com/andrewl/wherearetheyflyingto">https://github.com/andrewl/wherearetheyflyingto</a></p>
</div>
  <div id="map">
    <div class="heatmap" id="map-canvas"></div>
  </div>
</body>
<script src="js/heatmap.min.js"></script>
<script src="js/leaflet-heatmap.js"></script>
<script>
  Zepto(function($) {

    (function(i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-81858987-1', 'auto');
    ga('send', 'pageview');


    var baseLayer = L.tileLayer(
      'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data: <a href="https://www.openstreetmap.org/copyright" target="_other">&copy; OpenStreetMap contributors</a>',
        maxZoom: 18
      }
    );

    var cfg = {
      // radius should be small ONLY if scaleRadius is true (or small radius is intended)
      // if scaleRadius is false it will be the constant radius used in pixels
      "radius": 40,
      "maxOpacity": .8,
      // scales the radius based on map zoom
      "scaleRadius": false,
      // if set to false the heatmap uses the global maximum for colorization
      // if activated: uses the data maximum within the current map boundaries 
      //   (there will always be a red spot with useLocalExtremas true)
      "useLocalExtrema": false,
      // which field name in your data represents the latitude - default "lat"
      latField: 'lat',
      // which field name in your data represents the longitude - default "lng"
      lngField: 'lng',
      // which field name in your data represents the data value - default "value"
      valueField: 'count'
    };

    var heatmapLayer = new HeatmapOverlay(cfg);

    var map = new L.Map('map-canvas', {
      center: new L.LatLng(30, 31),
      zoom: 3,
      layers: [baseLayer, heatmapLayer]
    });

    // create the control
    var command = L.control({position: 'bottomleft'});

    command.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'altitude');
        div.innerHTML = '<div id="altitude_selector"></div>';
        return div;
    };

    command.addTo(map);

    var altitude_selector = document.getElementById('altitude_selector');

    noUiSlider.create(altitude_selector, {
      start: [0, 45000], // Handle start position
      step: 9000, // Slider moves in increments of '10'
      margin: 9000, // Handles must be more than '20' apart
      connect: true, // Display a colored bar between the handles
      direction: 'rtl', // Put '0' at the bottom of the slider
      orientation: 'vertical', // Orient the slider vertically
      behaviour: 'tap-drag', // Move handle on tap, bar is draggable
      range: { // Slider can select '0' to '100'
        'min': 0,
        'max': 45000
      },
      pips: { // Show a scale with the slider
        mode: 'steps',
        density: 9000
      }
    });

    var watft_destinations;

    $.ajax({
      type: 'GET',
      url: './watft_destinations.json',
      // type of data we are expecting in return:
      dataType: 'json',
      timeout: 300,
      success: function(data) {
        waft_destinations = data;
        // When the slider value changes, update the heatmap
        altitude_selector.noUiSlider.on('update', function(values, handle) {
          update_heatmap(values[0], values[1]);
        });
      },
      error: function(xhr, type) {
        alert('Failed to load heatmap data');
      }
    });

    var destinationData = {};
    update_heatmap = function(min_alt, max_alt) {
      destinationData = {
        max: 0,
        data: []
      };
      $(waft_destinations).each(function(idx, item) {
        if (item[3] > min_alt && item[3] <= max_alt) {
          destinationData.data.push({
            lat: item[0],
            lng: item[1],
            count: item[2],
            altitude: item[3]
          });
          if (destinationData.max < item[2]) {
            destinationData.max = item[2];
          }
        }
      });
      heatmapLayer.setData(destinationData);
    }

  });
</script>

</html>
